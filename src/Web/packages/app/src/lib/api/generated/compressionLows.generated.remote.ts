// AUTO-GENERATED - DO NOT EDIT
// Generated by @nocturne/remote-function-codegen
// Source: openapi.json

import { getRequestEvent, query, command } from '$app/server';
import { error, redirect } from '@sveltejs/kit';
import { z } from 'zod';
import { AcceptSuggestionRequestSchema, TriggerDetectionRequestSchema } from '$lib/api/generated/schemas';
import { CompressionLowStatus, type AcceptSuggestionRequest, type TriggerDetectionRequest } from '$api';

/** Get compression low suggestions with optional filtering */
export const getSuggestions = query(z.object({ status: z.enum(CompressionLowStatus).optional(), nightOf: z.string().optional() }).optional(), async (params) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.compressionLows.getSuggestions(params?.status, params?.nightOf);
  } catch (err) {
    const status = (err as any)?.status;
    if (status === 401) { const { url } = getRequestEvent(); throw redirect(302, `/login?redirectTo=${encodeURIComponent(url.pathname + url.search)}`); }
    if (status === 403) throw error(403, 'Forbidden');
    console.error('Error in compressionLows.getSuggestions:', err);
    throw error(500, 'Failed to get suggestions');
  }
});

/** Get a single suggestion with glucose entries for charting */
export const getSuggestion = query(z.string(), async (id) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.compressionLows.getSuggestion(id);
  } catch (err) {
    const status = (err as any)?.status;
    if (status === 401) { const { url } = getRequestEvent(); throw redirect(302, `/login?redirectTo=${encodeURIComponent(url.pathname + url.search)}`); }
    if (status === 403) throw error(403, 'Forbidden');
    console.error('Error in compressionLows.getSuggestion:', err);
    throw error(500, 'Failed to get suggestion');
  }
});

/** Delete a suggestion and its associated state span */
export const deleteSuggestion = command(z.string(), async (id) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    await apiClient.compressionLows.deleteSuggestion(id);
    await Promise.all([
      getSuggestions(undefined).refresh()
    ]);
    return { success: true };
  } catch (err) {
    const status = (err as any)?.status;
    if (status === 401) { const { url } = getRequestEvent(); throw redirect(302, `/login?redirectTo=${encodeURIComponent(url.pathname + url.search)}`); }
    if (status === 403) throw error(403, 'Forbidden');
    console.error('Error in compressionLows.deleteSuggestion:', err);
    throw error(500, 'Failed to delete suggestion');
  }
});

/** Accept a suggestion with adjusted bounds */
export const acceptSuggestion = command(z.object({ id: z.string(), request: AcceptSuggestionRequestSchema }), async ({ id, request }) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.compressionLows.acceptSuggestion(id, request as AcceptSuggestionRequest);
    await Promise.all([
      getSuggestions(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    const status = (err as any)?.status;
    if (status === 401) { const { url } = getRequestEvent(); throw redirect(302, `/login?redirectTo=${encodeURIComponent(url.pathname + url.search)}`); }
    if (status === 403) throw error(403, 'Forbidden');
    console.error('Error in compressionLows.acceptSuggestion:', err);
    throw error(500, 'Failed to accept suggestion');
  }
});

/** Dismiss a suggestion */
export const dismissSuggestion = command(z.string(), async (id) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    await apiClient.compressionLows.dismissSuggestion(id);
    await Promise.all([
      getSuggestions(undefined).refresh()
    ]);
    return { success: true };
  } catch (err) {
    const status = (err as any)?.status;
    if (status === 401) { const { url } = getRequestEvent(); throw redirect(302, `/login?redirectTo=${encodeURIComponent(url.pathname + url.search)}`); }
    if (status === 403) throw error(403, 'Forbidden');
    console.error('Error in compressionLows.dismissSuggestion:', err);
    throw error(500, 'Failed to dismiss suggestion');
  }
});

/** Manually trigger detection for a date range (for testing) */
export const triggerDetection = command(TriggerDetectionRequestSchema, async (request) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.compressionLows.triggerDetection(request as TriggerDetectionRequest);
    await Promise.all([
      getSuggestions(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    const status = (err as any)?.status;
    if (status === 401) { const { url } = getRequestEvent(); throw redirect(302, `/login?redirectTo=${encodeURIComponent(url.pathname + url.search)}`); }
    if (status === 403) throw error(403, 'Forbidden');
    console.error('Error in compressionLows.triggerDetection:', err);
    throw error(500, 'Failed to trigger detection');
  }
});
