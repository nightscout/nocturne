// AUTO-GENERATED - DO NOT EDIT
// Generated by @nocturne/remote-function-codegen
// Source: openapi.json

import { getRequestEvent, query, command } from '$app/server';
import { error } from '@sveltejs/kit';
import { z } from 'zod';
import { SubjectSchema, RoleSchema } from '$lib/api/generated/schemas';
import { type Subject, type Role } from '$api';

/** Get all permissions that have been seen by the system */
export const getAllPermissions = query(async () => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.authorization.getAllPermissions();
  } catch (err) {
    console.error('Error in authorization.getAllPermissions:', err);
    throw error(500, 'Failed to get all permissions');
  }
});

/** Get permission hierarchy structure as a trie */
export const getPermissionTrie = query(async () => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.authorization.getPermissionTrie();
  } catch (err) {
    console.error('Error in authorization.getPermissionTrie:', err);
    throw error(500, 'Failed to get permission trie');
  }
});

/** Get all subjects (users/devices) */
export const getAllSubjects = query(async () => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.authorization.getAllSubjects();
  } catch (err) {
    console.error('Error in authorization.getAllSubjects:', err);
    throw error(500, 'Failed to get all subjects');
  }
});

/** Create a new subject */
export const createSubject = command(SubjectSchema, async (request) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.authorization.createSubject(request as Subject);
    await Promise.all([
      getAllSubjects(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    console.error('Error in authorization.createSubject:', err);
    throw error(500, 'Failed to create subject');
  }
});

/** Update an existing subject */
export const updateSubject = command(SubjectSchema, async (request) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.authorization.updateSubject(request as Subject);
    await Promise.all([
      getAllSubjects(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    console.error('Error in authorization.updateSubject:', err);
    throw error(500, 'Failed to update subject');
  }
});

/** Delete a subject by ID */
export const deleteSubject = command(z.string(), async (id) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    await apiClient.authorization.deleteSubject(id);
    await Promise.all([
      getAllSubjects(undefined).refresh()
    ]);
    return { success: true };
  } catch (err) {
    console.error('Error in authorization.deleteSubject:', err);
    throw error(500, 'Failed to delete subject');
  }
});

/** Get all roles */
export const getAllRoles = query(async () => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.authorization.getAllRoles();
  } catch (err) {
    console.error('Error in authorization.getAllRoles:', err);
    throw error(500, 'Failed to get all roles');
  }
});

/** Create a new role */
export const createRole = command(RoleSchema, async (request) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.authorization.createRole(request as Role);
    await Promise.all([
      getAllRoles(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    console.error('Error in authorization.createRole:', err);
    throw error(500, 'Failed to create role');
  }
});

/** Update an existing role */
export const updateRole = command(RoleSchema, async (request) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.authorization.updateRole(request as Role);
    await Promise.all([
      getAllRoles(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    console.error('Error in authorization.updateRole:', err);
    throw error(500, 'Failed to update role');
  }
});

/** Delete a role by ID */
export const deleteRole = command(z.string(), async (id) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    await apiClient.authorization.deleteRole(id);
    await Promise.all([
      getAllRoles(undefined).refresh()
    ]);
    return { success: true };
  } catch (err) {
    console.error('Error in authorization.deleteRole:', err);
    throw error(500, 'Failed to delete role');
  }
});
