// AUTO-GENERATED - DO NOT EDIT
// Generated by @nocturne/remote-function-codegen
// Source: openapi.json

import { getRequestEvent, query, command } from '$app/server';
import { error } from '@sveltejs/kit';
import { z } from 'zod';
import { CreateTrackerDefinitionRequestSchema, UpdateTrackerDefinitionRequestSchema, StartTrackerInstanceRequestSchema, CompleteTrackerInstanceRequestSchema, AckTrackerRequestSchema, CreateTrackerPresetRequestSchema, ApplyPresetRequestSchema } from '$lib/api/generated/schemas';
import { TrackerCategory, type CreateTrackerDefinitionRequest, type UpdateTrackerDefinitionRequest, type StartTrackerInstanceRequest, type CompleteTrackerInstanceRequest, type AckTrackerRequest, type CreateTrackerPresetRequest, type ApplyPresetRequest } from '$api';

/** Get all tracker definitions. Returns public trackers for unauthenticated users,
or all visible trackers for authenticated users. */
export const getDefinitions = query(z.object({ category: z.enum(TrackerCategory).optional() }).optional(), async (params) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.trackers.getDefinitions(params?.category);
  } catch (err) {
    console.error('Error in trackers.getDefinitions:', err);
    throw error(500, 'Failed to get definitions');
  }
});

/** Create a new tracker definition */
export const createDefinition = command(CreateTrackerDefinitionRequestSchema, async (request) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.trackers.createDefinition(request as CreateTrackerDefinitionRequest);
    await Promise.all([
      getDefinitions(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    console.error('Error in trackers.createDefinition:', err);
    throw error(500, 'Failed to create definition');
  }
});

/** Get a specific tracker definition */
export const getDefinition = query(z.string(), async (id) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.trackers.getDefinition(id);
  } catch (err) {
    console.error('Error in trackers.getDefinition:', err);
    throw error(500, 'Failed to get definition');
  }
});

/** Update a tracker definition */
export const updateDefinition = command(z.object({ id: z.string(), request: UpdateTrackerDefinitionRequestSchema }), async ({ id, request }) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.trackers.updateDefinition(id, request as UpdateTrackerDefinitionRequest);
    await Promise.all([
      getDefinitions(undefined).refresh(),
      getDefinition(id).refresh()
    ]);
    return result;
  } catch (err) {
    console.error('Error in trackers.updateDefinition:', err);
    throw error(500, 'Failed to update definition');
  }
});

/** Delete a tracker definition */
export const deleteDefinition = command(z.string(), async (id) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    await apiClient.trackers.deleteDefinition(id);
    await Promise.all([
      getDefinitions(undefined).refresh()
    ]);
    return { success: true };
  } catch (err) {
    console.error('Error in trackers.deleteDefinition:', err);
    throw error(500, 'Failed to delete definition');
  }
});

/** Get active tracker instances */
export const getActiveInstances = query(async () => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.trackers.getActiveInstances();
  } catch (err) {
    console.error('Error in trackers.getActiveInstances:', err);
    throw error(500, 'Failed to get active instances');
  }
});

/** Start a new tracker instance */
export const startInstance = command(StartTrackerInstanceRequestSchema, async (request) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.trackers.startInstance(request as StartTrackerInstanceRequest);
    await Promise.all([
      getActiveInstances(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    console.error('Error in trackers.startInstance:', err);
    throw error(500, 'Failed to start instance');
  }
});

/** Get completed tracker instances (history) */
export const getInstanceHistory = query(z.object({ limit: z.number().optional() }).optional(), async (params) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.trackers.getInstanceHistory(params?.limit);
  } catch (err) {
    console.error('Error in trackers.getInstanceHistory:', err);
    throw error(500, 'Failed to get instance history');
  }
});

/** Get upcoming tracker expirations for calendar */
export const getUpcomingInstances = query(z.object({ from: z.coerce.date().optional(), to: z.coerce.date().optional() }).optional(), async (params) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.trackers.getUpcomingInstances(params?.from, params?.to);
  } catch (err) {
    console.error('Error in trackers.getUpcomingInstances:', err);
    throw error(500, 'Failed to get upcoming instances');
  }
});

/** Complete a tracker instance */
export const completeInstance = command(z.object({ id: z.string(), request: CompleteTrackerInstanceRequestSchema }), async ({ id, request }) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.trackers.completeInstance(id, request as CompleteTrackerInstanceRequest);
    await Promise.all([
      getActiveInstances(undefined).refresh(),
      getInstanceHistory(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    console.error('Error in trackers.completeInstance:', err);
    throw error(500, 'Failed to complete instance');
  }
});

/** Acknowledge/snooze a tracker notification */
export const ackInstance = command(z.object({ id: z.string(), request: AckTrackerRequestSchema }), async ({ id, request }) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    await apiClient.trackers.ackInstance(id, request as AckTrackerRequest);
    await Promise.all([
      getActiveInstances(undefined).refresh()
    ]);
    return { success: true };
  } catch (err) {
    console.error('Error in trackers.ackInstance:', err);
    throw error(500, 'Failed to ack instance');
  }
});

/** Delete a tracker instance */
export const deleteInstance = command(z.string(), async (id) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    await apiClient.trackers.deleteInstance(id);
    await Promise.all([
      getActiveInstances(undefined).refresh()
    ]);
    return { success: true };
  } catch (err) {
    console.error('Error in trackers.deleteInstance:', err);
    throw error(500, 'Failed to delete instance');
  }
});

/** Get all presets for the current user */
export const getPresets = query(async () => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    return await apiClient.trackers.getPresets();
  } catch (err) {
    console.error('Error in trackers.getPresets:', err);
    throw error(500, 'Failed to get presets');
  }
});

/** Create a new preset */
export const createPreset = command(CreateTrackerPresetRequestSchema, async (request) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.trackers.createPreset(request as CreateTrackerPresetRequest);
    await Promise.all([
      getPresets(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    console.error('Error in trackers.createPreset:', err);
    throw error(500, 'Failed to create preset');
  }
});

/** Apply a preset (starts a new instance) */
export const applyPreset = command(z.object({ id: z.string(), request: ApplyPresetRequestSchema.optional() }), async ({ id, request }) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    const result = await apiClient.trackers.applyPreset(id, (request ?? {}) as ApplyPresetRequest);
    await Promise.all([
      getActiveInstances(undefined).refresh()
    ]);
    return result;
  } catch (err) {
    console.error('Error in trackers.applyPreset:', err);
    throw error(500, 'Failed to apply preset');
  }
});

/** Delete a preset */
export const deletePreset = command(z.string(), async (id) => {
  const { locals } = getRequestEvent();
  const { apiClient } = locals;
  try {
    await apiClient.trackers.deletePreset(id);
    await Promise.all([
      getPresets(undefined).refresh()
    ]);
    return { success: true };
  } catch (err) {
    console.error('Error in trackers.deletePreset:', err);
    throw error(500, 'Failed to delete preset');
  }
});
